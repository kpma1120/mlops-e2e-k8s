name: CI/CD Deployment to GKE

on:
  push:
    branches:
      - main
    tags:
      - "init-data-*"
    paths-ignore:
      - "README.md"

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: "my-cluster"
  GKE_REGION: "us-east1"
  REPOSITORY: "us-east1-docker.pkg.dev/mlops-repo1/my-repo"
  FASTAPI_IMAGE: "us-east1-docker.pkg.dev/mlops-repo1/my-repo/fastapi"
  FLASK_IMAGE: "us-east1-docker.pkg.dev/mlops-repo1/my-repo/flask"
  GRAFANA_IMAGE: "grafana/grafana:latest"
  PROMETHEUS_IMAGE: "prom/prometheus:latest"

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12.7"
      - name: Install Ruff
        run: pip install ruff
      - name: Run Ruff Linter
        run: ruff check .

  test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12.7"
      - name: Install packages
        run: pip install --no-deps -e .
      - name: Install test dependencies
        run: pip install -r requirements-test.txt
      - name: Run tests
        run: pytest
      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results

  build-and-deploy:
    runs-on: ubuntu-latest
    container:
      image: google/cloud-sdk:latest
    needs: [lint, test]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Authenticate with Google cloud
        uses: 'google-github-actions/auth@v3'
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker us-east1-docker.pkg.dev

      - name: Install Docker CLI
        run: |
          apt-get update
          apt-get install -y docker.io

      - name: Build and Push FastAPI Image
        run: |
          docker build -t $FASTAPI_IMAGE:$GITHUB_SHA -t $FASTAPI_IMAGE:latest -f fastapi_api/Dockerfile ./
          docker push $FASTAPI_IMAGE:$GITHUB_SHA
          docker push $FASTAPI_IMAGE:latest

      - name: Build and Push Flask Image
        run: |
          docker build -t $FLASK_IMAGE:$GITHUB_SHA -t $FLASK_IMAGE:latest ./flask_ui
          docker push $FLASK_IMAGE:$GITHUB_SHA
          docker push $FLASK_IMAGE:latest

      - name: GKE Configuration
        run: gcloud container clusters get-credentials $GKE_CLUSTER --region $GKE_REGION --project $PROJECT_ID

      - name: Sync ConfigMaps from repo files
        run: |
          kubectl create configmap prometheus-config --from-file=prometheus.yml --dry-run=client -o yaml | kubectl apply -f -
          kubectl create configmap grafana-provisioning-dashboards --from-file=provisioning/dashboards --dry-run=client -o yaml | kubectl apply -f -
          kubectl create configmap grafana-provisioning-datasources --from-file=provisioning/datasources --dry-run=client -o yaml | kubectl apply -f -

      - name: Reload Prometheus config via API (with fallback)
        run: |
          kubectl port-forward svc/prometheus-service 9090:9090 &
          sleep 5
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://127.0.0.1:9090/-/reload)
          if [ "$STATUS" -ne 200 ]; then
            echo "Prometheus reload failed (HTTP $STATUS), fallback to rollout restart"
            if [[ "${GITHUB_REF}" == refs/tags/init-data-* ]]; then
              echo "Init-data deploy detected, skip fallback restart (will restart later)"
            else
              kubectl rollout restart deployment prometheus
            fi
          else
            echo "Prometheus reload succeeded"
          fi

      - name: Restart Grafana to pick up new ConfigMaps
        run: kubectl rollout restart deployment grafana

      - name: Apply PVC
        run: kubectl apply -f monitoring-pvc.yml

      - name: Deploy All Services
        run: kubectl apply -f all-services.yml

      - name: Update FastAPI Image
        run: kubectl set image deployment/fastapi fastapi=$FASTAPI_IMAGE:$GITHUB_SHA

      - name: Update Flask Image
        run: kubectl set image deployment/flask flask=$FLASK_IMAGE:$GITHUB_SHA

      - name: Initialize Prometheus Data (only on init-data-* tag)
        if: startsWith(github.ref, 'refs/tags/init-data-')
        run: |
          echo "Waiting for Prometheus deployment to be ready..."
          kubectl rollout status deployment prometheus --timeout=180s || echo "Prometheus not fully ready, proceeding with init anyway"

          echo "Packing snapshot blocks..."
          tar czf prometheus-data.tar.gz -C prometheus-data/ .

          PROM_POD=$(kubectl get pod -l app=prometheus -o jsonpath="{.items[0].metadata.name}")

          echo "Removing stale lock and TSDB runtime state files if exists..."
          kubectl exec $PROM_POD -- rm -rf /prometheus/lock /prometheus/01* /prometheus/chunks_head /prometheus/wal /prometheus/queries.active || true

          echo "Copying snapshot data into Prometheus PVC..."
          kubectl cp prometheus-data.tar.gz $PROM_POD:/prometheus

          echo "Extracting snapshot blocks into /prometheus..."
          kubectl exec $PROM_POD -- tar xzf /prometheus/prometheus-data.tar.gz -C /prometheus

          echo "Restart Prometheus to load snapshot..."
          kubectl rollout restart deployment prometheus

          echo "Prometheus snapshot restore step completed. Verify Grafana dashboards for data."

